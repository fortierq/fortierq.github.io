---
title: "Computer vision applied to the recognition of Magic cards"
tags:
  - ML
  - python
toc: true
toc_label: "Computer vision applied to the recognition of Magic cards"
toc_sticky: true
---

[Test the application using Azure OCR, Flask, Celery, Redis, SocketIO.](http://mtgscan.azurewebsites.net)

[![fortierq/mtgscan - GitHub](https://gh-card.dev/repos/fortierq/mtgscan.svg)](https://github.com/fortierq/mtgscan)

# Introduction

[Magic](https://magic.wizards.com/en) is a card game (played both online and IRL) in which you have to build a pile of cards (*deck*) to play against other players. The number of cards in a deck can be large (between 40 and 100, most of the time) and listing them (to attend a tournament or sell them, for example) can be tedious.  
In this article, I describe the development of **mtgscan**, a recognition tool to automatically list cards from an image, which can be a photo or a screenshot.

# Card recognition

Most attempts to recognize Magic cards seem to rely on using image processing and/or training a neural network (usually CNN) on the overall image.  
For example, [this](https://tmikonen.github.io/quantitatively/2020-01-01-magic-card-detector) article describe the following pipeline :  
- Pre-process the image: resizing, histogram equalization...  
- Segmentation: isolation of each card, by finding convex hulls
- Recognition: compute the perceptual hash of each card and compare it to a database of all hashs of known cards.  
[This other project](https://github.com/hj3yoo/mtg_card_detector) tried to use a neural network combined with perceptual hashing, but without improving much.

However, those attempts do not work if the cards are stacked, as is usually the case when listing a deck or collection.

Instead, I tried to use an OCR to recognize the title of the cards, rather than the whole image.

## Text recognition (OCR)

There are several existing OCR. I firstly tried [Tesseract](https://tesseract-ocr.github.io/) which is probably the best open-source OCR. However, the results were pretty bad.

Therefore, I tried proprietary, cloud solutions: 
- [Azure Read OCR](https://docs.microsoft.com/fr-fr/azure/cognitive-services/computer-vision/overview-ocr)
- [Google Cloud Vision](https://cloud.google.com/vision/docs/ocr)
- [AWS Textract](https://aws.amazon.com/textract)

Those OCR can be only used in the cloud and can't be used locally. They are free for a limited use, which is more than enough for me. For example, [the free tier of Azure OCR](https://azure.microsoft.com/en-us/pricing/details/cognitive-services/computer-vision) grant up to 20 requests by minute and 5000 by month.  
They are much more efficient that Tesseract and, after comparing them on few images, I opted for the Azure OCR.  
[](./mtgscan/ocr.jpg)

## Post-processing

## Results

## Web application with Flask

## REST API

## Docker

docker-compose up --build
docker login regmtgscan.azurecr.io
Go to Access Keys in Container Registry and enable the admin user, then use the autogenerated credentials to login via Docker

docker push regmtgscan.azurecr.io/server

In the Azure: App Service explorer, right-click the appropriate App Service and select Restart. Restarting an app service automatically pulls the latest container image from the registry.
2021-02-13T20:25:23.804Z INFO  - Initiating warmup request to container mtgs_0_12728eb7 for site mtgs
2021-02-13T20:25:34.097Z INFO  - Container mtgs_0_12728eb7 for site mtgs initialized successfully and is ready to serve requests.
2021-02-13T20:35:24.444Z INFO  - Pulling image: regmtgscan.azurecr.io/server:latest

docker ps
docker port mtgscan-app_redis_1
docker-compose push